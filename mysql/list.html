<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #000;
            color: #fff;
        }

        .table {
            color: #fff;
        }

        .btn-custom {
            background-color: #333;
            color: #fff;
        }

            .btn-custom:hover {
                background-color: #555;
                color: #fff;
            }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="mt-4">List Page</h2>
        <!-- 버튼을 클릭하여 데이터 추가 모달을 열 수 있음 -->
        <button type="button" class="btn btn-custom mb-3" data-toggle="modal" data-target="#insertModal">
            Add
            Data
        </button>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Actions</th>
                    <th>ID</th>
                    <th>Temperature</th>
                    <th>Humidity</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                <!-- dht 배열의 각 항목을 테이블 행으로 출력 -->
                <% dht.forEach(function(item, index){ %>
                <tr>
                    <td>
                        <!-- 데이터 삭제 및 수정 버튼 -->
                        <a href='/delete/<%= item.id %>' class="btn btn-custom btn-sm">Delete</a>
                        <button type="button" class="btn btn-custom btn-sm" data-toggle="modal"
                                data-target="#editModal" data-id="<%= item.id %>">
                            Edit
                        </button>
                    </td>
                    <td>
                        <%= item.id %>
                    </td>
                    <td>
                        <%= item.Temperature %>
                    </td>
                    <td>
                        <%= item.Humidity %>
                    </td>
                    <td>
                        <%= item.time %>
                    </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>

    <!-- 데이터 추가를 위한 모달 -->
    <div class="modal fade" id="insertModal" tabindex="-1" role="dialog" aria-labelledby="insertModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="insertModalLabel">Add Data</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="insertForm" method="post">
                        <div class="form-group">
                            <label for="temperature">Temperature</label>
                            <input type="text" class="form-control" id="insertTemperature" name="Temperature"
                                   placeholder="Enter temperature">
                        </div>
                        <div class="form-group">
                            <label for="humidity">Humidity</label>
                            <input type="text" class="form-control" id="insertHumidity" name="Humidity"
                                   placeholder="Enter humidity">
                        </div>
                        <button type="submit" class="btn btn-custom">Add</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 데이터 수정을 위한 모달 -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Data</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editForm" method="post">
                        <div class="form-group">
                            <label for="editId">ID</label>
                            <input type="text" class="form-control" id="editId" name="id" disabled>
                        </div>
                        <div class="form-group">
                            <label for="editTemperature">Temperature</label>
                            <input type="text" class="form-control" id="editTemperature" name="Temperature">
                        </div>
                        <div class="form-group">
                            <label for="editHumidity">Humidity</label>
                            <input type="text" class="form-control" id="editHumidity" name="Humidity">
                        </div>
                        <button type="submit" class="btn btn-custom">Update</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 의존성 -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
		// 새 데이터 추가 폼 제출 처리
		$('#insertForm').submit(function (event) {
			event.preventDefault(); // 기본 폼 제출 방지
			console.log('Form data:', $(this).serialize()); // 폼 데이터 로그

			// 서버에 POST 요청을 보내 데이터를 추가
			$.post('/insert', $(this).serialize(), function () {
				location.reload(); // 추가 후 페이지 새로 고침
			}).fail(function (jqXHR, textStatus, errorThrown) {
				console.error('Insert failed:', textStatus, errorThrown); // 실패 시 오류 로그
			});
		});

		// 수정 모달 표시 및 폼 데이터 로드
		$('#editModal').on('show.bs.modal', function (event) {
			var button = $(event.relatedTarget); // 모달을 여는 버튼
			var id = button.data('id'); // ID 추출

			console.log('Edit ID:', id); // ID 로그

			var modal = $(this);
			modal.find('#editId').val(id); // 수정 폼에 ID 입력

			// 해당 ID의 데이터를 서버에서 가져오기
			$.ajax({
				url: '/edit/' + id,
				method: 'GET',
				success: function (data) {
					console.log('Edit data:', data); // 데이터 로그
					if (data.dev01.length > 0) {
						var dev01 = data.dev01[0];
						modal.find('#editTemperature').val(dev01.Temperature); // 온도 설정
						modal.find('#editHumidity').val(dev01.Humidity); // 습도 설정
					} else {
						alert("No data found for this ID."); // 데이터 없음 경고
					}
				},
				error: function () {
					alert("Failed to load data."); // 로드 실패 경고
				}
			});
		});

		// 데이터 수정 폼 제출 처리
		$('#editForm').submit(function (event) {
			event.preventDefault(); // 기본 폼 제출 방지

			// 업데이트된 데이터를 서버에 POST 요청으로 전송
			$.post('/edit/' + $('#editId').val(), $(this).serialize(), function () {
				location.reload(); // 수정 후 페이지 새로 고침
			}).fail(function (jqXHR, textStatus, errorThrown) {
				console.error('Update failed:', textStatus, errorThrown); // 실패 시 오류 로그
			});
		});
    </script>
</body>

</html>